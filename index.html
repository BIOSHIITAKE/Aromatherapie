<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aromath√©rapie Scientifique ‚Äî Prototype Master</title>
<style>
  :root{
    --accent:#00695c; --muted:#5d6b6a; --card:#fff; --warn:#f6c; --danger:#ffdddd;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, "Segoe UI", Roboto, Arial; margin:0; background:#f4f7f6; color:#122; line-height:1.4}
  header{background:linear-gradient(120deg,var(--accent),#004d40); color:#fff; padding:1.1rem; text-align:center}
  header h1{margin:.1rem; font-size:1.4rem}
  .wrap{max-width:1200px; margin:1rem auto; padding:1rem}
  .grid{display:grid; grid-template-columns: 1fr 420px; gap:1rem}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:var(--card); border-radius:10px; padding:1rem; box-shadow:0 6px 18px rgba(10,30,25,.04); border:1px solid #e6efee}
  label{font-weight:600; color:var(--muted); display:block; margin:0.4rem 0 0.2rem}
  input[type="text"], select, input[type="number"], textarea {width:100%; padding:.5rem .6rem; border-radius:8px; border:1px solid #d6e6e3}
  small.muted{color:var(--muted); display:block; margin-top:.4rem}
  .controls{display:flex; gap:.6rem; flex-wrap:wrap; align-items:center}
  .pill{padding:.35rem .6rem; background:#eef7f3; color:var(--accent); border-radius:999px; cursor:pointer; border:1px solid #e0f0ea}
  .pill.active{background:var(--accent); color:white}
  .he-list{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:.8rem; margin-top:.6rem}
  .he-item{padding:.6rem; border-radius:8px; border:1px solid #e7f0ee; background:#fff; cursor:pointer}
  .he-item h4{margin:.05rem 0 .2rem}
  .muted{color:var(--muted)}
  table{width:100%; border-collapse:collapse; margin-top:.6rem; background:#fff}
  th,td{border:1px solid #e6eeec; padding:.5rem; vertical-align:top; font-size:.95rem}
  th{background:#f1fcf8; color:var(--accent); font-weight:700}
  button.btn{background:var(--accent); color:#fff; border:0; padding:.45rem .7rem; border-radius:8px; cursor:pointer}
  button.ghost{background:transparent; border:1px solid #cfe8e0; color:var(--accent); padding:.35rem .6rem; border-radius:8px}
  .badge{display:inline-block;padding:.22rem .5rem;border-radius:6px;background:#eef7f3;color:var(--accent);font-weight:700;margin-right:.3rem}
  .alert{background:#fff0f0;color:#7a1212;padding:.6rem;border-radius:8px;border:1px solid #ffd6d6;margin-top:.6rem}
  .info{background:#fffaf0;color:#6a4d00;padding:.6rem;border-radius:8px;border:1px solid #ffecb3;margin-top:.6rem}
  #detail pre{white-space:pre-wrap;background:#fbfffb;padding:.6rem;border-radius:6px;border:1px solid #e6f4ec}
  footer{padding:1rem;text-align:center;color:var(--muted);font-size:.9rem;margin-top:1rem}
  .toprow{display:flex;gap:.5rem;align-items:center}
  .fileControls{display:flex;gap:.4rem;flex-wrap:wrap}
  .export{background:#003f35;color:white;padding:.45rem .7rem;border-radius:8px;border:0;cursor:pointer}
  .small{font-size:.85rem}
</style>
</head>
<body>
<header>
  <h1>Aromath√©rapie Scientifique ‚Äî Prototype Master</h1>
  <small>Prototype p√©dagogique & scientifique ‚Äî pr√™t √† int√©grer ta banque SSPM</small>
</header>

<div class="wrap">

  <div style="display:flex;justify-content:space-between;gap:1rem;flex-wrap:wrap;margin-bottom:.8rem">
    <div style="display:flex;gap:.5rem;align-items:center">
      <button class="btn" id="btnNewHE">+ Nouvelle HE</button>
      <button class="ghost" id="btnImport">Importer JSON</button>
      <button class="export" id="btnExport">Exporter JSON</button>
      <input type="file" id="fileInput" accept=".json" style="display:none">
    </div>

    <div class="toprow muted small">
      Version prototype ‚Äî donn√©es √©chantillon incluses ‚Ä¢ D√©place ta base SSPM via "Importer JSON".
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: search & results -->
    <div>

      <div class="card">
        <label for="search">Recherche (nom / mol√©cule / propri√©t√© / indication)</label>
        <input id="search" type="text" placeholder="ex : linalol, calmante, stress ‚Äî accents non requis">
        <small class="muted">Tol√©rance aux fautes (¬±2), insensible aux accents</small>

        <div style="display:flex;gap:.6rem;margin-top:.6rem;align-items:center">
          <div>
            <label>Filtrer par voie</label>
            <select id="filterVoie">
              <option value="">‚Äî toutes ‚Äî</option>
              <option>Voie cutan√©e</option>
              <option>Voie olfactive</option>
              <option>Diffusion</option>
              <option>Voie orale dilu√©e</option>
            </select>
          </div>
          <div>
            <label>Risques √† exclure</label>
            <select id="excludeRisk">
              <option value="">‚Äî aucun ‚Äî</option>
              <option value="grossesse">Grossesse</option>
              <option value="renal">Insuffisance r√©nale</option>
              <option value="photosens">Photosensibilisant</option>
            </select>
          </div>
          <div style="align-self:end">
            <label style="opacity:0">action</label>
            <button class="ghost" id="resetFilters">R√©init</button>
          </div>
        </div>

        <div id="results" class="he-list" aria-live="polite"></div>
        <div id="noresults" class="muted" style="margin-top:.6rem"></div>
      </div>

      <div class="card" style="margin-top:1rem">
        <h3>Formulations exemples</h3>
        <div id="formulations"></div>
      </div>

    </div>

    <!-- RIGHT: detail / mix -->
    <aside>

      <div id="detail" class="card">
        <h3>Fiche d√©taill√©e</h3>
        <div id="detailContent" class="muted">S√©lectionne une HE √† gauche ou cr√©e-en une nouvelle.</div>
      </div>

      <div id="mixCard" class="card" style="margin-top:1rem">
        <h3>üß™ M√©langeur & Calculateur de synergie</h3>
        <small class="muted">Clique sur une HE pour l'ajouter au m√©lange.</small>

        <table id="mixTable" style="margin-top:.6rem">
          <thead><tr><th>HE</th><th>Mol√©cules</th><th>Propri√©t√©s</th><th>Voies</th><th>%</th><th>‚®Ø</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="display:flex;gap:.5rem;align-items:center;margin-top:.6rem">
          <label style="margin:0">Total %</label>
          <input id="totalPercent" type="number" value="0" min="0" max="100" step="0.1" style="width:120px">
          <button class="btn" id="distributeEven">Distribuer √©quitablement</button>
          <button class="ghost" id="exportMix">Exporter mix</button>
        </div>

        <div id="synergy" style="margin-top:.8rem"></div>
      </div>

    </aside>
  </div>

  <!-- gal√©nique & references -->
  <div class="card" style="margin-top:1rem">
    <h3>üìö Gal√©nique, R√©f√©rences & Conseils</h3>
    <div id="galenicAdvice" class="muted">
      Le moteur propose formes gal√©niques en fonction de la voie et des mol√©cules dominantes (ex. alcool tertiaire ‚Üí compatibilit√© transdermique, esters ‚Üí tol√©rance cutan√©e...).<br>
      Importe ta base SSPM pour recommandations automatis√©es par evidence-level.
    </div>
    <pre id="galenicOutput" style="margin-top:.6rem"></pre>
  </div>

</div>

<footer>¬© 2025 ‚Äì Laurent Aromath√©rapie scientifique ¬∑ Prototype</footer>

<script>
/* ===========================
   DATA MODEL SAMPLE (editable)
   =========================== */
let DB = {
  huiles: [
    {
      id: "HE001",
      nom: "Lavande vraie",
      latin: "Lavandula angustifolia",
      famille: "Lamiaceae",
      partie: "Fleurs",
      rendement: "1.2%",
      origine: "Provence, FR",
      chemotype: "Linalol / Ac√©tate de linalyle",
      couleur: "Jaune p√¢le",
      odeur: "Florale, douce",
      densite: "0.885",
      composition: [
        {nom:"Linalol", pct:35, classe:"Alcool monoterp√©nique"},
        {nom:"Ac√©tate de linalyle", pct:40, classe:"Ester"}
      ],
      proprietes: ["Calmante","Antispasmodique","R√©g√©n√©ratrice cutan√©e"],
      indications: ["Stress","Troubles du sommeil"],
      voies: ["Voie cutan√©e","Voie olfactive"],
      restrictions: {grossesse:false, renal:false, photosens:false, ageMin:7},
      maxDosePerVoie: { "Voie cutan√©e":10, "Voie olfactive":100, "Voie orale dilu√©e":1 },
      references: [{source:"PubMed", id:"PMC8001530", author:"Cimino et al.", year:2021}],
      evidence: "B"
    },
    {
      id: "HE002",
      nom: "Tea tree",
      latin: "Melaleuca alternifolia",
      famille: "Myrtaceae",
      partie: "Feuilles",
      rendement: "0.8%",
      origine: "Australie",
      chemotype: "Terpin√®ne-4-ol",
      couleur: "Incolore",
      odeur: "Camphr√©e, fra√Æche",
      densite: "0.885",
      composition: [
        {nom:"Terpin√®ne-4-ol", pct:40, classe:"Alcool terpenique"},
        {nom:"gamma-Terpinene", pct:20, classe:"Monoterpene"}
      ],
      proprietes: ["Antibact√©rienne","Antifongique"],
      indications: ["Infections cutan√©es","Acn√©"],
      voies: ["Voie cutan√©e","Diffusion"],
      restrictions: {grossesse:true, renal:false, photosens:false, ageMin:7},
      maxDosePerVoie: { "Voie cutan√©e":10, "Diffusion":100, "Voie orale dilu√©e":0.5 },
      references: [{source:"WHO", id:"TEA-2020", author:"WHO monograph"}],
      evidence: "B"
    },
    {
      id:"HE003",
      nom:"Menthe poivr√©e",
      latin:"Mentha √ó piperita",
      famille:"Lamiaceae",
      partie:"Feuilles",
      rendement:"0.9%",
      origine:"Europe",
      chemotype:"Menthol",
      densite:"0.890",
      composition:[{nom:"Menthol", pct:40, classe:"Monoterpenol"},{nom:"Menthone", pct:20, classe:"Monoterpene"}],
      proprietes:["Tonique","Digestive","Antalgique locale"],
      indications:["Maux de t√™te","Troubles digestifs"],
      voies:["Voie cutan√©e","Voie orale dilu√©e"],
      restrictions:{grossesse:true, renal:false, photosens:false, ageMin:12},
      maxDosePerVoie:{"Voie cutan√©e":2,"Voie orale dilu√©e":0.5,"Diffusion":0},
      references:[{source:"EFSA", id:"MENT-2019"}],
      evidence:"C"
    },
    {
      id:"HE004",
      nom:"Citron",
      latin:"Citrus limon",
      famille:"Rutaceae",
      partie:"Zeste",
      rendement:"0.5%",
      origine:"Italie",
      chemotype:"Limonene",
      composition:[{nom:"Limonene",pct:65,classe:"Monoterpene"},{nom:"beta-pinene",pct:10,classe:"Monoterpene"}],
      proprietes:["Tonique","D√©purative"],
      indications:["Fatigue","Digestif"],
      voies:["Diffusion","Voie cutan√©e"],
      restrictions:{grossesse:false, renal:false, photosens:true, ageMin:7},
      maxDosePerVoie:{"Voie cutan√©e":2,"Diffusion":100,"Voie orale dilu√©e":0},
      references:[{source:"PubMed", id:"CIT-2021"}],
      evidence:"C"
    },
    {
      id:"HE005",
      nom:"Ylang-ylang compl√®te",
      latin:"Cananga odorata",
      famille:"Annonaceae",
      composition:[{nom:"Germacrene D",pct:15},{nom:"Benzoate de benzyle",pct:10}],
      proprietes:["Relaxante","Hypotensive","Aphrodisiaque"],
      indications:["Stress","Hypertension"],
      voies:["Voie cutan√©e","Diffusion"],
      restrictions:{grossesse:true, renal:false, photosens:false, ageMin:7},
      maxDosePerVoie:{"Voie cutan√©e":5,"Diffusion":50,"Voie orale dilu√©e":0},
      evidence:"C"
    },
    {
      id:"HE006",
      nom:"Gen√©vrier commun",
      latin:"Juniperus communis",
      famille:"Cupressaceae",
      composition:[{nom:"alpha-pinene"},{nom:"sabinene"},{nom:"myrcene"},{nom:"terpinene-4-ol",pct:2}],
      proprietes:["Anti-inflammatoire","Cholagogue","Anti-infectieuse"],
      indications:["Stimulation h√©patique","Infections"],
      voies:["Voie cutan√©e","Diffusion"],
      restrictions:{grossesse:true, renal:true, photosens:false, ageMin:12},
      maxDosePerVoie:{"Voie cutan√©e":3,"Diffusion":30,"Voie orale dilu√©e":0.5},
      evidence:"C"
    }
  ],
  molecules: [
    {id:"M001", nom:"Linalol", formule:"C10H18O", classe:"Alcool monoterp√©nique", notes:"Calmant"},
    {id:"M002", nom:"Terpin√®ne-4-ol", classe:"Alcool terpenique"},
    {id:"M003", nom:"Menthol", classe:"Monoterpenol"},
    {id:"M004", nom:"Limonene", classe:"Monoterpene"}
  ],
  formulations: [
    {id:"F001", nom:"Complexe relaxant", composition:[{he:"HE001",pct:30},{he:"HE005",pct:20}], support:"Huile veg macadamia 30mL", usage:"Soir, application sur plexus"}
  ]
};

/* ===========================
   UTILITIES: normalization, fuzzy
   =========================== */
function normalize(s){ if(!s && s!==0) return ""; return String(s).normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }

// Levenshtein distance (small)
function levenshtein(a,b){
  if(a===b) return 0;
  const m = Array.from({length:b.length+1}, (_,i)=>[i]);
  m[0] = Array.from({length:a.length+1}, (_,j)=>j);
  for(let i=1;i<=b.length;i++){
    for(let j=1;j<=a.length;j++){
      m[i][j] = (b[i-1]===a[j-1]) ? m[i-1][j-1] : 1 + Math.min(m[i-1][j-1], m[i][j-1], m[i-1][j]);
    }
  }
  return m[b.length][a.length];
}

/* ===========================
   RENDER RESULTS
   =========================== */
const resultsEl = document.getElementById('results');
const noresults = document.getElementById('noresults');
const detailContent = document.getElementById('detailContent');
const mixTableBody = document.querySelector('#mixTable tbody');
const synergyEl = document.getElementById('synergy');
const galenicOutput = document.getElementById('galenicOutput');
let MIX = [];

// fuzzy-friendly match
function fuzzyMatchField(field, query){
  const norm = normalize(field);
  if(norm.includes(query)) return true;
  // tolerate small typos on prefix
  const prefix = norm.slice(0, Math.max(query.length,3));
  return levenshtein(prefix, query) <= 2;
}

function renderResults(){
  const qRaw = document.getElementById('search').value || "";
  const q = normalize(qRaw);
  const voie = document.getElementById('filterVoie').value;
  const excludeRisk = document.getElementById('excludeRisk').value;

  resultsEl.innerHTML = "";
  let matches = DB.huiles.filter(h=>{
    // filter by voie
    if(voie && (!h.voies || !h.voies.includes(voie))) return false;
    // exclude risk
    if(excludeRisk){
      if(excludeRisk==="grossesse" && h.restrictions && h.restrictions.grossesse) return false;
      if(excludeRisk==="renal" && h.restrictions && h.restrictions.renal) return false;
      if(excludeRisk==="photosens" && h.restrictions && h.restrictions.photosens) return false;
    }
    if(!q) return true;
    // check many fields
    const fields = [
      h.nom, h.latin, h.famille, h.chemotype,
      ...(h.composition||[]).map(c=>c.nom),
      ...(h.proprietes||[]), ...(h.indications||[])
    ];
    return fields.some(f => fuzzyMatchField(f,q));
  });

  if(matches.length === 0){
    noresults.textContent = q ? "Aucun r√©sultat ‚Äî essaie une autre mol√©cule ou r√©duis les filtres." : "Tape un terme pour rechercher (ex: linalol, stress).";
    return;
  } else {
    noresults.textContent = "";
  }

  // render cards
  matches.forEach(h=>{
    const d = document.createElement('div');
    d.className = 'he-item';
    d.innerHTML = `<h4>${h.nom}</h4><div class="muted"><em>${h.latin||''}</em></div>
      <div style="margin-top:.4rem"><strong>Mol√©cules:</strong> ${(h.composition||[]).map(c=>c.nom + (c.pct?` (${c.pct}%)`:"")).join(', ')}</div>
      <div class="muted" style="margin-top:.3rem"><strong>Propri√©t√©s:</strong> ${(h.proprietes||[]).join(', ')}</div>
      <div style="margin-top:.4rem"><button class="ghost" data-id="${h.id||h.nom}">Voir</button> <button class="btn" data-add="${h.id||h.nom}">Ajouter</button></div>`;
    // view
    d.querySelector('[data-id]').onclick = ()=> showDetail(h);
    // add
    d.querySelector('[data-add]').onclick = ()=> addToMix(h);
    resultsEl.appendChild(d);
  });
}

/* ===========================
   DETAIL VIEW
   =========================== */
function showDetail(h){
  const comp = (h.composition||[]).map(c=>`‚Ä¢ ${c.nom}${c.pct?` ‚Äî ${c.pct}%`:''} (${c.classe||'‚Äì'})`).join('\n');
  const refs = (h.references||[]).map(r=>`‚Ä¢ ${r.source || r.titre || 'ref'} ${r.id?`(${r.id})`:''} ${r.year?` ‚Äî ${r.year}`:''}`).join('\n') || 'Aucune';
  detailContent.innerHTML = `
    <h4>${h.nom} <small class="muted"> ‚Äî ${h.latin||''}</small></h4>
    <div class="muted">${h.famille?`Famille: ${h.famille}`:''} ${h.partie?`‚Ä¢ Partie: ${h.partie}`:''} ${h.origine?`‚Ä¢ Origine: ${h.origine}`:''}</div>
    <div style="margin-top:.5rem"><strong>Ch√©motype:</strong> ${h.chemotype||'‚Äî'}</div>
    <div style="margin-top:.5rem"><strong>Composition principale:</strong><pre>${comp}</pre></div>
    <div><strong>Propri√©t√©s:</strong> ${(h.proprietes||[]).join(', ')}</div>
    <div><strong>Indications:</strong> ${(h.indications||[]).join(', ')}</div>
    <div style="margin-top:.5rem"><strong>Voies:</strong> ${(h.voies||[]).join(', ')}</div>
    <div style="margin-top:.6rem"><strong>Restrictions:</strong> ${(h.restrictions? Object.entries(h.restrictions).filter(([k,v])=>v).map(([k])=>k).join(', '):'Aucune')}</div>
    <div style="margin-top:.6rem"><strong>Max dose par voie (ex):</strong> ${JSON.stringify(h.maxDosePerVoie||{})}</div>
    <div style="margin-top:.6rem"><strong>R√©f√©rences:</strong><pre>${refs}</pre></div>
    <div style="margin-top:.6rem" class="muted small">Niveau de preuve: ${h.evidence||'N/A'}</div>
  `;
}

/* ===========================
   MIX / SYNERGY logic
   =========================== */
function addToMix(h){
  // avoid duplicates by id or nom
  if(MIX.find(x=>x.id && h.id && x.id===h.id) || MIX.find(x=>x.nom===h.nom)) {
    alert("D√©j√† dans le m√©lange");
    return;
  }
  MIX.push(h);
  renderMix();
  computeSynergy();
}

function removeFromMix(idx){
  MIX.splice(idx,1);
  renderMix();
  computeSynergy();
}

function renderMix(){
  mixTableBody.innerHTML = "";
  MIX.forEach((h,i)=>{
    const tr = document.createElement('tr');
    const mols = (h.composition||[]).map(c=>c.nom + (c.pct?` (${c.pct}%)`:'')).join(', ');
    const props = (h.proprietes||[]).join(', ');
    const voies = (h.voies||[]).join(', ');
    const pctInput = `<input type="number" data-idx="${i}" class="pct" value="${(100/MIX.length).toFixed(1)}" min="0" max="100" step="0.1" style="width:80px">`;
    tr.innerHTML = `<td>${h.nom}</td><td>${mols}</td><td>${props}</td><td>${voies}</td><td>${pctInput}</td><td><button class="btn" data-rm="${i}">√ó</button></td>`;
    mixTableBody.appendChild(tr);
  });
  // attach events
  document.querySelectorAll('#mixTable [data-rm]').forEach(b=> b.onclick = ()=> removeFromMix(Number(b.dataset.rm)));
  document.querySelectorAll('#mixTable .pct').forEach(inp=> inp.onchange = (e)=> { recomputeTotal(); });
  recomputeTotal();
}

/* Recompute total percentage & checks */
function recomputeTotal(){
  const inputs = Array.from(document.querySelectorAll('#mixTable .pct'));
  let total = 0;
  inputs.forEach(i => total += parseFloat(i.value || 0));
  document.getElementById('totalPercent').value = Number(total.toFixed(2));
  // check >100%
  const alertsDiv = document.getElementById('alerts');
  alertsDiv.innerHTML = "";
  if(total > 100.01) {
    alertsDiv.innerHTML = `<div class="alert">Total > 100% ‚Äî ajuste les pourcentages.</div>`;
  }
  // dose checks against maxDosePerVoie
  performDoseChecks();
  computeSynergy(); // update synergy when percents change
}

/* distribute even */
document.getElementById('distributeEven').onclick = ()=>{
  if(MIX.length===0) return;
  const val = (100 / MIX.length).toFixed(2);
  document.querySelectorAll('#mixTable .pct').forEach(inp=> inp.value = val);
  recomputeTotal();
}

/* Export mix */
document.getElementById('exportMix').onclick = ()=>{
  if(MIX.length===0) return alert("M√©lange vide");
  // collect mix with percent
  const pctEls = document.querySelectorAll('#mixTable .pct');
  const data = MIX.map((h,i)=> ({id:h.id||null, nom:h.nom, percent: Number(pctEls[i].value||0)}));
  const blob = new Blob([JSON.stringify({mix:data, generatedAt:new Date().toISOString()},null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'mix_aromatherapie.json'; a.click(); URL.revokeObjectURL(url);
}

/* compute synergy & properties */
function computeSynergy(){
  const box = synergyEl;
  box.innerHTML = "";
  if(MIX.length===0){ box.innerHTML = `<div class="muted">Aucun HE s√©lectionn√©.</div>`; galenicOutput.textContent=""; return; }
  // collect molecules weighted by pct
  const pctEls = document.querySelectorAll('#mixTable .pct');
  let accumMolecules = {}; // name -> weighted sum (pct*relative)
  let accumProps = new Set();
  let accumVoies = new Set();
  MIX.forEach((h,i)=>{
    const pct = Number((pctEls[i] && pctEls[i].value) || (100/MIX.length));
    (h.composition||[]).forEach(comp=>{
      const weight = (comp.pct || 0) * (pct/100);
      accumMolecules[comp.nom] = (accumMolecules[comp.nom] || 0) + weight;
    });
    (h.proprietes||[]).forEach(p => accumProps.add(p));
    (h.voies||[]).forEach(v=>accumVoies.add(v));
  });
  // sort molecules by contribution
  const molList = Object.entries(accumMolecules).sort((a,b)=>b[1]-a[1]);
  // build box
  const molHtml = molList.length ? molList.map(([n,v])=>`<div><strong>${n}</strong> ‚Äî contribution estim√©e ${Number(v.toFixed(2))}</div>`).join('') : '<div class="muted">Aucune mol√©cule quantifi√©e</div>';
  const propsHtml = Array.from(accumProps).map(p=>`<span class="badge">${p}</span>`).join(' ');
  const voiesHtml = Array.from(accumVoies).join(', ') || '‚Äî';

  box.innerHTML = `<div><strong>Mol√©cules dominantes (estimation)</strong>${molHtml}</div>
                   <div style="margin-top:.6rem"><strong>Propri√©t√©s cumul√©es:</strong> ${propsHtml}</div>
                   <div style="margin-top:.6rem"><strong>Voies cumul√©es:</strong> ${voiesHtml}</div>`;
  // simple interaction warnings
  const warnings = [];
  // pregnancy warnings
  MIX.forEach(h=>{
    if(h.restrictions && h.restrictions.grossesse) warnings.push(`${h.nom} ‚Äî d√©conseill√© en grossesse`);
    if(h.restrictions && h.restrictions.renal) warnings.push(`${h.nom} ‚Äî prudence insuffisance r√©nale`);
    if(h.restrictions && h.restrictions.photosens) warnings.push(`${h.nom} ‚Äî photosensibilisant`);
    if(h.restrictions && h.restrictions.ageMin) warnings.push(`${h.nom} ‚Äî √¢ge min ${h.restrictions.ageMin} ans`);
  });
  // incompatibility example: if menthol (neuroactive) high + pregnancy -> warn
  const mentholScore = (accumMolecules["Menthol"]||0);
  if(mentholScore > 5) warnings.push("Menthol significatif ‚Äî prudence chez jeunes enfants / grossesse");
  // show warnings
  const alertsDiv = document.getElementById('alerts');
  alertsDiv.innerHTML = warnings.length ? warnings.map(w=>`<div class="alert">${w}</div>`).join('') : '';

  // galenic suggestion: choose form by dominant voie + molecules
  let suggestion = "Forme recommand√©e: ";
  if(Array.from(accumVoies).includes("Voie cutan√©e")){
    suggestion += "Pr√©parer une base huileuse (huiles v√©g√©tales antioxydantes) ; si mol√©cules volatiles dominantes ‚Üí micro-√©mulsion pour stabilit√©.";
  } else if(Array.from(accumVoies).includes("Diffusion") || Array.from(accumVoies).includes("Voie olfactive")) {
    suggestion += "Diffuseur √† froid ; √©viter HE photosensibilisantes en diffusion intense.";
  } else {
    suggestion += "Adapter selon voie d'administration.";
  }
  galenicOutput.textContent = suggestion;
}

/* perform dose checks vs maxDosePerVoie */
function performDoseChecks(){
  const alertsDiv = document.getElementById('alerts');
  // clear existing non-overlapping dose warnings
  // compute for each HE: pct and for each voie check against maxDose
  const pctEls = document.querySelectorAll('#mixTable .pct');
  let doseWarnings = [];
  MIX.forEach((h,i)=>{
    const pct = Number((pctEls[i] && pctEls[i].value) || (100/MIX.length));
    if(!h.maxDosePerVoie) return;
    // pick each voie present in mix
    (h.voies||[]).forEach(voie=>{
      const max = h.maxDosePerVoie[voie] || null;
      if(max !== null && max !== undefined && max>=0 && voie){
        // Here we interpret % as % of final formulation not absolute mg/kg. Warn if pct > max recommended %
        if(pct > max){
          doseWarnings.push(`${h.nom} (${voie}) : % dans m√©lange ${pct}% > limite recommand√©e ${max}%`);
        }
      }
    });
  });
  // append dose warnings preserving existing warnings
  if(doseWarnings.length){
    const existing = alertsDiv.innerHTML;
    alertsDiv.innerHTML = (existing ? existing : '') + doseWarnings.map(d=>`<div class="alert">${d}</div>`).join('');
  }
}

/* ===========================
   IMPORT / EXPORT JSON (easy DB load)
   =========================== */

document.getElementById('btnImport').onclick = ()=> document.getElementById('fileInput').click();
document.getElementById('fileInput').onchange = function(e){
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(ev){
    try{
      const parsed = JSON.parse(ev.target.result);
      // very permissive merge if structure matches
      if(parsed.huiles) DB.huiles = parsed.huiles.concat(DB.huiles);
      if(parsed.molecules) DB.molecules = (parsed.molecules||[]).concat(DB.molecules);
      if(parsed.formulations) DB.formulations = (parsed.formulations||[]).concat(DB.formulations||[]);
      alert("Import OK ‚Äî base mise √† jour (fusion).");
      renderResults();
      renderFormulations();
    }catch(err){
      alert("Erreur lecture JSON: " + err.message);
    }
  };
  reader.readAsText(f);
};

document.getElementById('btnExport').onclick = ()=>{
  const blob = new Blob([JSON.stringify(DB,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'aroma_db_export.json'; a.click(); URL.revokeObjectURL(url);
};

/* new HE modal (simple prompt-based) */
document.getElementById('btnNewHE').onclick = ()=>{
  const name = prompt("Nom commun de l'HE (ex: Basilic)"); if(!name) return;
  const latin = prompt("Nom latin (optionnel)"); const id = "HE" + String(Date.now()).slice(-6);
  const newHE = {id:id, nom:name, latin:latin || "", composition:[], proprietes:[], indications:[], voies:[], restrictions:{}, maxDosePerVoie:{}};
  // simple insert
  DB.huiles.unshift(newHE);
  renderResults();
  alert(`HE '${name}' cr√©√©e (ID ${id}). Edite la fiche via 'Voir' pour compl√©ter.`);
};

/* render formulations list */
function renderFormulations(){
  const el = document.getElementById('formulations');
  el.innerHTML = "";
  (DB.formulations||[]).forEach(f=>{
    const div = document.createElement('div'); div.className='muted';
    div.innerHTML = `<strong>${f.nom}</strong> ‚Äî ${f.usage || ''} <div class="small">${(f.composition||[]).map(c=>`${c.he} ${c.pct?c.pct+'%':''}`).join(', ')}</div>`;
    el.appendChild(div);
  });
}

/* initial render */
renderResults();
renderFormulations();

/* events */
document.getElementById('search').addEventListener('input', ()=> { renderResults(); });
document.getElementById('filterVoie').addEventListener('change', ()=> renderResults());
document.getElementById('excludeRisk').addEventListener('change', ()=> renderResults());
document.getElementById('resetFilters').addEventListener('click', ()=>{ document.getElementById('search').value=''; document.getElementById('filterVoie').value=''; document.getElementById('excludeRisk').value=''; renderResults(); });

/* small UX: clicking exported mix or file input done earlier */
/* End of script */
</script>
</body>
</html>

